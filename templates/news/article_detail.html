{% extends 'base_news.html' %}
{% load sanitize %}

{% block title %}{{ article.meta_title|default:article.title }} - {{ current_site.name }}{% endblock %}
{% block meta_description %}{{ article.meta_description|default:article.excerpt }}{% endblock %}

{# ── Open Graph overrides ── #}
{% block og_tags %}
<meta property="og:site_name" content="{{ current_site.name }}">
<meta property="og:type" content="article">
<meta property="og:title" content="{{ article.meta_title|default:article.title }}">
<meta property="og:description" content="{{ article.meta_description|default:article.excerpt }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if article.featured_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ article.featured_image.url }}">
{% endif %}
<meta property="article:published_time" content="{{ article.published_at|date:'c' }}">
{% if article.category %}
<meta property="article:section" content="{{ article.category.name }}">
{% endif %}
{% for tag in article.tags.all %}
<meta property="article:tag" content="{{ tag.name }}">
{% endfor %}
{% endblock %}

{# ── Twitter Cards overrides ── #}
{% block twitter_tags %}
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ article.meta_title|default:article.title }}">
<meta name="twitter:description" content="{{ article.meta_description|default:article.excerpt }}">
{% if article.featured_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ article.featured_image.url }}">
{% endif %}
{% endblock %}

{# ── JSON-LD Structured Data ── #}
{% block json_ld %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": "{{ article.title|escapejs }}",
  "description": "{{ article.excerpt|escapejs }}",
  "datePublished": "{{ article.published_at|date:'c' }}",
  "dateModified": "{{ article.updated_at|date:'c' }}",
  {% if article.featured_image %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ article.featured_image.url }}",{% endif %}
  {% if article.author %}"author": {
    "@type": "Person",
    "name": "{{ article.author.get_full_name|default:article.author.username|escapejs }}"
  },{% endif %}
  "publisher": {
    "@type": "Organization",
    "name": "{{ current_site.name|escapejs }}"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom typography scale for the article to match high-end editorial standards */
    .article-body p {
        margin-bottom: 1.5em;
        font-size: 1.125rem;
        line-height: 1.8;
        color: #334155;
        /* slate-700 */
    }

    .dark .article-body p {
        color: #cbd5e1;
        /* slate-300 */
    }

    .article-body h2 {
        font-size: 1.875rem;
        font-weight: 600;
        margin-top: 2.5em;
        margin-bottom: 1em;
        line-height: 1.3;
        letter-spacing: -0.02em;
        color: #0f172a;
        /* slate-900 */
    }

    .dark .article-body h2 {
        color: #f1f5f9;
        /* slate-100 */
    }

    .article-body h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 2em;
        margin-bottom: 0.75em;
        color: #0f172a;
    }

    .dark .article-body h3 {
        color: #f1f5f9;
    }

    .article-body>p:first-of-type::first-letter {
        float: left;
        font-size: 4.5rem;
        line-height: 0.85;
        padding-right: 0.15em;
        font-weight: 700;
        color: #1152d4;
        /* primary */
    }

    /* Lists inside article body */
    .article-body ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-bottom: 1.5em;
    }

    .article-body ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-bottom: 1.5em;
    }

    .article-body li {
        margin-bottom: 0.5em;
        color: #334155;
    }

    .dark .article-body li {
        color: #cbd5e1;
    }
</style>
{% endblock %}

{% block content %}
<main>
    <article class="relative mx-auto max-w-[960px] px-6 py-12 lg:px-0">
        <!-- Article Header Group -->
        <div class="mx-auto max-w-[720px] mb-12">
            <!-- Breadcrumbs -->
            <div class="mb-6 flex items-center gap-2 text-sm font-medium tracking-wide">
                <a class="text-primary hover:text-primary/80 transition-colors uppercase"
                    href="{% url 'news:list' %}"><span x-text="t('Notícias', 'News')">News</span></a>
                <span class="text-slate-300 dark:text-slate-700">/</span>
                {% if article.category %}
                <a class="text-slate-500 dark:text-slate-400 uppercase hover:text-primary transition-colors"
                    href="{% url 'news:category_detail' article.category.slug %}">
                    {{ article.category.name }}
                </a>
                {% else %}
                <span class="text-slate-500 dark:text-slate-400 uppercase"
                    x-text="t('Artigo', 'Article')">Article</span>
                {% endif %}
            </div>

            <!-- Headline -->
            <h1
                class="mb-6 text-4xl font-bold leading-[1.1] tracking-[-0.02em] text-slate-900 dark:text-slate-50 sm:text-5xl md:text-6xl font-display">
                {{ article.title }}
            </h1>

            <!-- Subtitle (Excerpt) -->
            {% if article.excerpt %}
            <p class="mb-8 text-xl leading-relaxed text-slate-600 dark:text-slate-400 font-normal font-display">
                {{ article.excerpt }}
            </p>
            {% endif %}

            <!-- Author Meta -->
            <div
                class="flex items-center justify-between border-t border-b border-slate-200 dark:border-slate-800 py-4">
                <div class="flex items-center gap-3">
                    {% if article.author %}
                    <div class="h-10 w-10 overflow-hidden rounded-full bg-slate-200">
                        {% if article.author.avatar %}
                        <img src="{{ article.author.avatar.url }}" alt="{{ article.author.get_full_name }}"
                            class="h-full w-full object-cover">
                        {% else %}
                        <div
                            class="h-full w-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">
                            {{ article.author.get_full_name|default:article.author.username|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-slate-900 dark:text-slate-100 font-ui">{{ article.author.get_full_name|default:article.author.username }}</span>
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-ui">{{ article.published_at|date:"M d, Y" }} • {{ article.reading_time }} <span x-text="t('min de leitura', 'min read')">min
                                read</span></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Header Actions -->
                <div class="flex items-center gap-2">
                    <!-- Save Bookmark Button (HTMX) -->
                    {% include 'news/partials/bookmark_button.html' with article=article is_bookmarked=is_bookmarked %}
                    <button :aria-label="t('Compartilhar Artigo', 'Share Article')"
                        onclick="if(navigator.share){navigator.share({title:'{{ article.title|escapejs }}',url:window.location.href})}else{alert('Link copied!')}"
                        class="group flex h-8 w-8 items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <span
                            class="material-symbols-outlined text-[20px] text-slate-400 group-hover:text-primary transition-colors">ios_share</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Featured Image -->
        {% if article.featured_image %}
        <div class="mb-16 w-full overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-900 shadow-sm">
            <img src="{{ article.featured_image.url }}" alt="{{ article.title }}"
                class="aspect-[21/9] w-full object-cover">
            {% if article.featured_image_caption %}
            <div class="mt-3 px-4 text-center">
                <p class="text-xs text-slate-500 dark:text-slate-400 font-ui">
                    {{ article.featured_image_caption }}
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Content Wrapper -->
        <div class="relative mx-auto max-w-[720px]">
            <!-- Sticky Social Sidebar (Desktop) -->
            <div class="hidden xl:flex absolute -left-24 top-0 h-full flex-col">
                <div class="sticky top-24 flex flex-col gap-4">
                    <!-- Like Button with Count (HTMX) -->
                    {% include 'news/partials/like_button.html' with article=article like_count=like_count is_liked=is_liked %}

                    <!-- Comments Link with Count -->
                    <div class="flex flex-col items-center gap-1">
                        <button
                            onclick="document.getElementById('comments-section').scrollIntoView({behavior: 'smooth'})"
                            class="group flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white shadow-sm hover:border-primary/50 hover:text-primary dark:border-slate-700 dark:bg-background-dark dark:text-slate-400 transition-all outline-none"
                            :aria-label="t('Comentários', 'Comments')">
                            <span class="material-symbols-outlined text-[20px]">chat_bubble</span>
                        </button>
                        <span class="text-xs font-bold text-slate-500 font-ui">{{ comment_count }}<span class="sr-only">
                                comments</span></span>
                    </div>

                    <div class="my-2 h-px w-6 self-center bg-slate-200 dark:bg-slate-800"></div>

                    <!-- Share -->
                    <button
                        onclick="if(navigator.share){navigator.share({title:'{{ article.title|escapejs }}',url:window.location.href})}else{alert('Link copied!')}"
                        class="group flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white shadow-sm hover:border-primary/50 hover:text-primary dark:border-slate-700 dark:bg-background-dark dark:text-slate-400 transition-all outline-none"
                        :aria-label="t('Compartilhar Artigo', 'Share Article')">
                        <span class="material-symbols-outlined text-[20px]">share</span>
                    </button>
                </div>
            </div>

            <!-- Article Body -->
            <div class="article-body font-display">
                {{ article.content|sanitize_html }}
            </div>

            <!-- Article Footer -->
            <div class="mt-16 border-t border-slate-200 dark:border-slate-800 pt-8">
                <div class="flex flex-wrap gap-2 mb-8">
                    {% for tag in article.tags.all %}
                    <a href="{% url 'news:tag_detail' tag.slug %}"
                        class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:bg-slate-800 dark:text-slate-300 hover:bg-primary/10 hover:text-primary transition-colors font-ui">
                        {{ tag.name }}
                    </a>
                    {% endfor %}
                </div>



                <!-- Comments Section -->
                <div id="comments-section" class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-800">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white font-display">
                            <span x-text="t('Comentários', 'Comments')">Comments</span>
                            <span class="text-slate-500 font-normal ml-2 font-ui text-lg">({{ comment_count }})</span>
                        </h3>
                    </div>

                    {% if user.is_authenticated %}
                    <!-- New Comment Form (authenticated) -->
                    <form hx-post="{% url 'news:add_comment' article.pk %}" hx-target="#comments-list"
                        hx-swap="outerHTML" hx-on::after-request="this.reset()" class="mb-10 flex flex-col gap-3">
                        {% csrf_token %}
                        <textarea name="content" rows="3" required
                            :placeholder="t('Escreva seu comentário...', 'Write your comment...')"
                            placeholder="Escreva seu comentário..."
                            class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 px-4 py-3 text-sm text-slate-900 dark:text-white placeholder-slate-400 focus:border-primary focus:ring-1 focus:ring-primary font-ui outline-none resize-none transition-all"></textarea>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="font-ui text-sm font-bold bg-primary text-white px-6 py-2 rounded shadow-sm hover:bg-primary/90 transition-colors">
                                <span x-text="t('Publicar Comentário', 'Post Comment')">Publicar Comentário</span>
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <!-- Prompt de login (não autenticado) -->
                    <div
                        class="mb-12 p-6 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800 flex flex-col items-center text-center">
                        <span
                            class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600 mb-3">lock</span>
                        <h4 class="font-bold text-slate-900 dark:text-white font-display mb-2"
                            x-text="t('Participe da Conversa', 'Join the Conversation')">Join the Conversation</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-ui mb-4 max-w-sm"
                            x-text="t('Você precisa ter uma conta para publicar comentários.', 'You need an account to post comments.')">
                            You need an account to post comments.
                        </p>
                        <div class="flex gap-3">
                            <a href="{% url 'accounts:login' %}?next={{ request.path|urlencode }}"
                                class="font-ui text-sm font-bold bg-primary text-white px-6 py-2 rounded shadow-sm hover:bg-primary/90 transition-colors"
                                x-text="t('Fazer Login', 'Log In')">Log In</a>
                            <a href="{% url 'accounts:register' %}"
                                class="font-ui text-sm font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 px-6 py-2 rounded shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                                x-text="t('Cadastrar', 'Sign Up')">Sign Up</a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comments List (rendered via partial, retargetable via HTMX) -->
                    {% include 'news/partials/comments_list.html' with comments=comments article=article %}
                </div>

                <!-- Engagement Box (Newsletter) Discreet -->
                <div class="mt-20 pt-12 border-t border-slate-200 dark:border-slate-800 text-center"
                    id="article-newsletter">
                    <h3 class="mb-5 text-xl font-bold text-slate-900 dark:text-white font-display"
                        x-text="t('Gostou? Inscreva-se e receba nossas notícias mais recentes', 'Enjoyed it? Subscribe and get our latest news')">
                        Gostou? Inscreva-se e receba minhas notícias mais recentes
                    </h3>
                    <form hx-post="{% url 'news:newsletter_subscribe' %}" hx-target="this" hx-swap="outerHTML"
                        class="flex flex-col sm:flex-row gap-3 justify-center max-w-sm mx-auto">
                        {% csrf_token %}
                        <input name="email" type="email" required
                            :placeholder="t('Insira seu endereço de e-mail', 'Enter your email address')"
                            placeholder="Insira seu endereço de e-mail"
                            class="flex-1 rounded-full border border-slate-300 bg-transparent px-5 py-2.5 text-slate-900 focus:border-primary focus:ring-1 focus:ring-primary dark:border-slate-700 dark:text-white dark:placeholder-slate-400 font-ui text-sm outline-none transition-all">
                        <button type="submit"
                            class="rounded-full bg-slate-900 dark:bg-white px-8 py-2.5 font-bold text-white dark:text-black transition-colors hover:opacity-90 font-ui text-sm shadow-sm">
                            <span x-text="t('Assinar', 'Subscribe')">Assinar</span>
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </article>

    <!-- Read Next Section -->
    {% if related_articles %}
    <section class="border-t border-slate-200 bg-white py-16 dark:border-slate-800 dark:bg-background-dark">
        <div class="mx-auto max-w-[960px] px-6 lg:px-0">
            <h3 class="mb-8 text-sm font-bold uppercase tracking-widest text-slate-400 font-ui"
                x-text="t('Leia a Seguir', 'Read Next')">Read Next</h3>
            <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                {% for article in related_articles %}
                <a class="group flex flex-col gap-3" href="{% url 'news:article_detail' article.slug %}">
                    <div class="overflow-hidden rounded-lg bg-slate-200 h-48 w-full">
                        {% if article.featured_image %}
                        <img src="{{ article.featured_image.url }}" alt="{{ article.title }}"
                            class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105">
                        {% else %}
                        <div class="h-full w-full bg-slate-200 flex items-center justify-center text-slate-400">
                            <span class="material-symbols-outlined text-4xl">image</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex flex-col gap-1">
                        {% if article.category %}
                        <span class="text-xs font-bold uppercase text-primary font-ui">{{ article.category.name }}</span>
                        {% endif %}
                        <h4
                            class="text-lg font-bold leading-tight text-slate-900 group-hover:text-primary dark:text-slate-100 transition-colors font-display">
                            {{ article.title }}
                        </h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-ui"><span
                                x-text="t('Por', 'By')">By</span> {{ article.author.get_full_name|default:article.author.username }} • {{ article.reading_time }}
                            <span x-text="t('min de leitura', 'min read')">min read</span>
                        </p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</main>
{% endblock %}